#!/bin/bash
# kubctl-0x01
# Script to scale Django app, verify pods, run load test, and monitor usage

set -e  # stop on first error

DEPLOYMENT="django-messaging-app"
SERVICE="django-messaging-service"
NAMESPACE="default"

echo "Scaling deployment $DEPLOYMENT to 3 replicas..."
kubectl scale deployment $DEPLOYMENT --replicas=3 -n $NAMESPACE

echo "Waiting for pods to be ready..."
kubectl rollout status deployment/$DEPLOYMENT -n $NAMESPACE

echo "Current pods:"
kubectl get pods -l app=django-messaging -o wide -n $NAMESPACE

echo "Exposing the service locally on port 8000..."
kubectl port-forward service/$SERVICE 8000:8000 -n $NAMESPACE &
PF_PID=$!
sleep 5   # give port-forward time to establish

echo "Running load test with wrk (10s, 100 connections, 4 threads)..."
wrk -t4 -c100 -d10s http://127.0.0.1:8000/ || echo "wrk not installed, skipping load test."

echo "Monitoring resource usage..."
kubectl top pods -n $NAMESPACE || echo "Metrics server not installed, skipping resource usage."

# Kill port-forward when done
kill $PF_PID 2>/dev/null || true

echo "Done."
