#!/bin/bash

set -e

echo "Deploying Blue version..."
kubectl apply -f blue_deployment.yaml
kubectl apply -f kubeservice.yaml

echo "Waiting for Blue pods to be ready..."
kubectl wait --for=condition=available --timeout=60s deployment/django-blue

echo "Checking Blue pod logs..."
BLUE_POD=$(kubectl get pods -l app=django,version=blue -o jsonpath="{.items[0].metadata.name}")
kubectl logs $BLUE_POD --tail=20

echo "Deploying Green version..."
kubectl apply -f green_deployment.yaml

echo "Waiting for Green pods to be ready..."
kubectl wait --for=condition=available --timeout=60s deployment/django-green

echo "Checking Green pod logs..."
GREEN_POD=$(kubectl get pods -l app=django,version=green -o jsonpath="{.items[0].metadata.name}")
kubectl logs $GREEN_POD --tail=20

echo "If Green logs look good, switch traffic by updating kubeservice.yaml to version=green and re-applying."
